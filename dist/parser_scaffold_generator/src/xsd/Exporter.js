"use strict";
// This file is part of cxsd, copyright (c) 2015-2016 BusFaster Ltd.
// Released under the MIT license, see LICENSE.
Object.defineProperty(exports, "__esModule", { value: true });
exports.exportNamespace = void 0;
var types = require("./types");
var schema = require("../schema");
function mergeDuplicateTypes(typeList) {
    if (typeList.length < 2)
        return (typeList);
    var tbl = {};
    for (var _i = 0, typeList_1 = typeList; _i < typeList_1.length; _i++) {
        var type = typeList_1[_i];
        tbl[type.surrogateKey] = type;
    }
    return (Object.keys(tbl).map(function (key) { return tbl[key]; }));
}
function exportMemberRef(spec, parentScope, namespace, context) {
    var member = spec.item;
    var outMember = member.getOutMember(context);
    var outRef = new schema.MemberRef(outMember, spec.min, spec.max);
    if (!outMember.typeList)
        exportMember(member, outRef, parentScope, namespace, context);
    return (outRef);
}
function exportMember(member, outRef, parentScope, namespace, context) {
    var outMember = outRef.member;
    var scope = member.getScope();
    var otherNamespace = scope.namespace;
    outMember.comment = scope.getComments();
    if (otherNamespace != parentScope.namespace) {
        outMember.namespace = context.copyNamespace(otherNamespace);
    }
    else
        outMember.namespace = namespace;
    outMember.typeList = mergeDuplicateTypes(member.getTypes()).map(function (type) {
        var outType = type.getOutType(context);
        var qName = type.qName;
        if (!qName && !type.name && !type.exported) {
            // Anonymous type defined only within this element.
            outType.containingRef = outRef;
            // Look through parent scopes for a containing type,
            // If the member was referenced from another namespace,
            // its scope points to definition in that namespace.
            var parentType = scope.getParentType(otherNamespace);
            if (parentType) {
                outType.containingType = parentType.getOutType(context);
            }
            exportType(type, outMember.namespace, context);
        }
        return (outType);
    });
    outMember.isAbstract = member.isAbstract();
    if (member instanceof types.Element) {
        if (member.substitutes) {
            outMember.substitutes = member.substitutes.getOutMember(context);
            outMember.namespace.pendingSubstituteList.push(outMember);
        }
        if (member.isSubstituted)
            outMember.isSubstituted = true;
    }
}
function exportAttributes(scope, namespace, context, type) {
    var memberTbl = scope.dumpMembers('attribute', 'attributeGroup');
    for (var _i = 0, _a = Object.keys(memberTbl).sort(); _i < _a.length; _i++) {
        var key = _a[_i];
        var ref = exportMemberRef(memberTbl[key], scope, namespace, context);
        type.addAttribute(ref);
    }
}
function exportChildren(scope, namespace, context, outType, setExported) {
    var memberTbl = scope.dumpMembers('element', 'group');
    for (var _i = 0, _a = Object.keys(memberTbl).sort(); _i < _a.length; _i++) {
        var key = _a[_i];
        var ref = exportMemberRef(memberTbl[key], scope, namespace, context);
        if (setExported)
            ref.member.isExported = true;
        outType.addChild(ref);
    }
}
/* TODO
function exportGroups(scope: Scope, namespace: schema.Namespace, context: schema.Context) {
//	var groupTbl = scope.dumpGroups();
    var groupList: schema.Member[] = [];

    return(groupList);
}
*/
function exportType(type, namespace, context) {
    var scope = type.getScope();
    var comment = scope.getComments();
    type.exported = true;
    var outType = type.getOutType(context);
    outType.comment = comment;
    outType.bytePos = type.bytePos;
    // If the type derives from a primitive type, it may have text content.
    var parentPrimitive = type.getParent(types.Primitive, false);
    if (parentPrimitive) {
        // Get equivalent JavaScript type.
        outType.primitiveType = parentPrimitive.getOutType(context);
        // Check if primitive type is inherited without any additional attributes
        // or children, so contents can be represented as a JavaScript primitive.
        // NOTE: Substitutions won't be applied to such types!
        parentPrimitive = type.getParent(types.Primitive, true);
    }
    if (parentPrimitive) {
        var literalList;
        var parentSimple = type.getParent(types.SimpleType, false);
        if (parentSimple) {
            // If parent is restricted to enumerated alternatives, output those instead.
            literalList = parentSimple.getEnumerationList();
            if (literalList)
                literalList = literalList.map(function (content) { return '"' + content + '"'; });
        }
        outType.literalList = literalList;
        outType.isPlainPrimitive = true;
        outType.primitiveType = parentPrimitive.getOutType(context);
    }
    var parent = type.parent;
    if (parent instanceof types.TypeBase && parent != parentPrimitive) {
        outType.parent = parent.getOutType(context);
    }
    exportAttributes(scope, namespace, context, outType);
    exportChildren(scope, namespace, context, outType, false);
    //	outType.groupList = exportGroups(scope, namespace, context);
    var listType = type.getListType();
    if (listType) {
        for (var _i = 0, listType_1 = listType; _i < listType_1.length; _i++) {
            var spec = listType_1[_i];
            var outMember = new schema.Member('');
            var outMemberRef = new schema.MemberRef(outMember, spec.min, spec.max);
            outMember.namespace = namespace;
            outMember.typeList = [
                exportType(spec.item, namespace, context)
            ];
            outType.addChild(outMemberRef);
        }
        outType.isList = true;
    }
    return (outType);
}
/** Export parsed xsd into a simpler internal schema format. */
function exportNamespace(namespace, context) {
    var outNamespace = context.copyNamespace(namespace);
    var doc = outNamespace.doc;
    if (doc)
        return (doc);
    //	if(!doc) {
    var scope = namespace.getScope();
    var sourceList = namespace.getSourceList();
    var importTbl = {};
    for (var _i = 0, sourceList_1 = sourceList; _i < sourceList_1.length; _i++) {
        var source = sourceList_1[_i];
        var namespaceRefTbl = source.getNamespaceRefs();
        for (var _a = 0, _b = Object.keys(namespaceRefTbl); _a < _b.length; _a++) {
            var name = _b[_a];
            var otherNamespace = namespaceRefTbl[name];
            outNamespace.addRef(name, context.copyNamespace(otherNamespace));
            importTbl[otherNamespace.id] = otherNamespace;
        }
    }
    outNamespace.sourceList = sourceList.map(function (source) { return source.url; }).sort();
    for (var _c = 0, _d = scope.dumpTypes('type') || []; _c < _d.length; _c++) {
        var spec = _d[_c];
        if (spec.name)
            exportType(spec.item, outNamespace, context).isExported = true;
    }
    doc = new schema.Type(null);
    doc.namespace = outNamespace;
    exportAttributes(scope, outNamespace, context, doc);
    exportChildren(scope, outNamespace, context, doc, true);
    outNamespace.doc = doc;
    for (var _e = 0, _f = Object.keys(importTbl); _e < _f.length; _e++) {
        var namespaceId = _f[_e];
        exportNamespace(importTbl[namespaceId], context);
    }
    for (var _g = 0, _h = outNamespace.pendingSubstituteList; _g < _h.length; _g++) {
        var member = _h[_g];
        var proxy = member.substitutes.getProxy();
        if (member.substitutes.namespace == member.namespace) {
            if (member.isSubstituted || member.isAbstract) {
                proxy.addMixin(member.getProxy());
            }
            else {
                proxy.addChildSpec(member);
            }
        }
        else {
            member.namespace.addAugmentation(proxy, member);
        }
    }
    //	}
    return (doc);
}
exports.exportNamespace = exportNamespace;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiRXhwb3J0ZXIuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyIuLi8uLi8uLi8uLi9wYXJzZXJfc2NhZmZvbGRfZ2VuZXJhdG9yL3NyYy94c2QvRXhwb3J0ZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLG9FQUFvRTtBQUNwRSwrQ0FBK0M7OztBQUsvQywrQkFBaUM7QUFDakMsa0NBQW9DO0FBT3BDLFNBQVMsbUJBQW1CLENBQUMsUUFBMEI7SUFDdEQsSUFBRyxRQUFRLENBQUMsTUFBTSxHQUFHLENBQUM7UUFBRSxPQUFNLENBQUMsUUFBUSxDQUFDLENBQUM7SUFFekMsSUFBSSxHQUFHLEdBQW9DLEVBQUUsQ0FBQztJQUU5QyxLQUFnQixVQUFRLEVBQVIscUJBQVEsRUFBUixzQkFBUSxFQUFSLElBQVE7UUFBcEIsSUFBSSxJQUFJLGlCQUFBO1FBQWMsR0FBRyxDQUFDLElBQUksQ0FBQyxZQUFZLENBQUMsR0FBRyxJQUFJLENBQUM7S0FBQTtJQUV4RCxPQUFNLENBQUMsTUFBTSxDQUFDLElBQUksQ0FBQyxHQUFHLENBQUMsQ0FBQyxHQUFHLENBQUMsVUFBQyxHQUFXLElBQUssT0FBQSxHQUFHLENBQUMsR0FBRyxDQUFDLEVBQVIsQ0FBUSxDQUFDLENBQUMsQ0FBQztBQUN6RCxDQUFDO0FBRUQsU0FBUyxlQUFlLENBQUMsSUFBZ0IsRUFBRSxXQUFrQixFQUFFLFNBQTJCLEVBQUUsT0FBdUI7SUFDbEgsSUFBSSxNQUFNLEdBQUcsSUFBSSxDQUFDLElBQXdCLENBQUM7SUFDM0MsSUFBSSxTQUFTLEdBQUcsTUFBTSxDQUFDLFlBQVksQ0FBQyxPQUFPLENBQUMsQ0FBQztJQUM3QyxJQUFJLE1BQU0sR0FBRyxJQUFJLE1BQU0sQ0FBQyxTQUFTLENBQUMsU0FBUyxFQUFFLElBQUksQ0FBQyxHQUFHLEVBQUUsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBRWpFLElBQUcsQ0FBQyxTQUFTLENBQUMsUUFBUTtRQUFFLFlBQVksQ0FBQyxNQUFNLEVB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MURELDBDQTBEQyIsInNvdXJjZXNDb250ZW50IjpbIi8vIFRoaXMgZmlsZSBpcyBwYXJ0IG9mIGN4c2QsIGNvcHlyaWdodCAoYykgMjAxNS0yMDE2IEJ1c0Zhc3RlciBMdGQuXG4vLyBSZWxlYXNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UsIHNlZSBMSUNFTlNFLlxuXG5pbXBvcnQge05hbWVzcGFjZX0gZnJvbSAnLi9OYW1lc3BhY2UnO1xuaW1wb3J0IHtTY29wZSwgVHlwZU1lbWJlcn0gZnJvbSAnLi9TY29wZSc7XG5pbXBvcnQge1NvdXJjZX0gZnJvbSAnLi9Tb3VyY2UnO1xuaW1wb3J0ICogYXMgdHlwZXMgZnJvbSAnLi90eXBlcyc7XG5pbXBvcnQgKiBhcyBzY2hlbWEgZnJvbSAnLi4vc2NoZW1hJztcblxuaW50ZXJmYWNlIE1lbWJlckdyb3VwIGV4dGVuZHMgVHlwZU1lbWJlciB7XG5cdGl0ZW06IHR5cGVzLk1lbWJlckJhc2U7XG5cdHR5cGVMaXN0OiB0eXBlcy5UeXBlQmFzZVtdO1xufVxuXG5mdW5jdGlvbiBtZXJnZUR1cGxpY2F0ZVR5cGVzKHR5cGVMaXN0OiB0eXBlcy5UeXBlQmFzZVtdKSB7XG5cdGlmKHR5cGVMaXN0Lmxlbmd0aCA8IDIpIHJldHVybih0eXBlTGlzdCk7XG5cblx0dmFyIHRibDoge1trZXk6IHN0cmluZ106IHR5cGVzLlR5cGVCYXNlfSA9IHt9O1xuXG5cdGZvcih2YXIgdHlwZSBvZiB0eXBlTGlzdCkgdGJsW3R5cGUuc3Vycm9nYXRlS2V5XSA9IHR5cGU7XG5cblx0cmV0dXJuKE9iamVjdC5rZXlzKHRibCkubWFwKChrZXk6IHN0cmluZykgPT4gdGJsW2tleV0pKTtcbn1cblxuZnVuY3Rpb24gZXhwb3J0TWVtYmVyUmVmKHNwZWM6IFR5cGVNZW1iZXIsIHBhcmVudFNjb3BlOiBTY29wZSwgbmFtZXNwYWNlOiBzY2hlbWEuTmFtZXNwYWNlLCBjb250ZXh0OiBzY2hlbWEuQ29udGV4dCkge1xuXHR2YXIgbWVtYmVyID0gc3BlYy5pdGVtIGFzIHR5cGVzLk1lbWJlckJhc2U7XG5cdHZhciBvdXRNZW1iZXIgPSBtZW1iZXIuZ2V0T3V0TWVtYmVyKGNvbnRleHQpO1xuXHR2YXIgb3V0UmVmID0gbmV3IHNjaGVtYS5NZW1iZXJSZWYob3V0TWVtYmVyLCBzcGVjLm1pbiwgc3BlYy5tYXgpO1xuXG5cdGlmKCFvdXRNZW1iZXIudHlwZUxpc3QpIGV4cG9ydE1lbWJlcihtZW1iZXIsIG91dFJlZiwgcGFyZW50U2NvcGUsIG5hbWVzcGFjZSwgY29udGV4dCk7XG5cblx0cmV0dXJuKG91dFJlZik7XG59XG5cbmZ1bmN0aW9uIGV4cG9ydE1lbWJlcihtZW1iZXI6IHR5cGVzLk1lbWJlckJhc2UsIG91dFJlZjogc2NoZW1hLk1lbWJlclJlZiwgcGFyZW50U2NvcGU6IFNjb3BlLCBuYW1lc3BhY2U6IHNjaGVtYS5OYW1lc3BhY2UsIGNvbnRleHQ6IHNjaGVtYS5Db250ZXh0KSB7XG5cdHZhciBvdXRNZW1iZXIgPSBvdXRSZWYubWVtYmVyO1xuXHR2YXIgc2NvcGUgPSBtZW1iZXIuZ2V0U2NvcGUoKTtcblx0dmFyIG90aGVyTmFtZXNwYWNlID0gc2NvcGUubmFtZXNwYWNlO1xuXG5cdG91dE1lbWJlci5jb21tZW50ID0gc2NvcGUuZ2V0Q29tbWVudHMoKTtcblxuXHRpZihvdGhlck5hbWVzcGFjZSAhPSBwYXJlbnRTY29wZS5uYW1lc3BhY2UpIHtcblx0XHRvdXRNZW1iZXIubmFtZXNwYWNlID0gY29udGV4dC5jb3B5TmFtZXNwYWNlKG90aGVyTmFtZXNwYWNlKTtcblx0fSBlbHNlIG91dE1lbWJlci5uYW1lc3BhY2UgPSBuYW1lc3BhY2U7XG5cblx0b3V0TWVtYmVyLnR5cGVMaXN0ID0gbWVyZ2VEdXBsaWNhdGVUeXBlcyhtZW1iZXIuZ2V0VHlwZXMoKSkubWFwKFxuXHRcdCh0eXBlOiB0eXBlcy5UeXBlQmFzZSkgPT4ge1xuXHRcdFx0dmFyIG91dFR5cGUgPSB0eXBlLmdldE91dFR5cGUoY29udGV4dCk7XG5cdFx0XHR2YXIgcU5hbWUgPSB0eXBlLnFOYW1lO1xuXG5cdFx0XHRpZighcU5hbWUgJiYgIXR5cGUubmFtZSAmJiAhdHlwZS5leHBvcnRlZCkge1xuXHRcdFx0XHQvLyBBbm9ueW1vdXMgdHlwZSBkZWZpbmVkIG9ubHkgd2l0aGluIHRoaXMgZWxlbWVudC5cblxuXHRcdFx0XHRvdXRUeXBlLmNvbnRhaW5pbmdSZWYgPSBvdXRSZWY7XG5cblx0XHRcdFx0Ly8gTG9vayB0aHJvdWdoIHBhcmVudCBzY29wZXMgZm9yIGEgY29udGFpbmluZyB0eXBlLFxuXHRcdFx0XHQvLyBJZiB0aGUgbWVtYmVyIHdhcyByZWZlcmVuY2VkIGZyb20gYW5vdGhlciBuYW1lc3BhY2UsXG5cdFx0XHRcdC8vIGl0cyBzY29wZSBwb2ludHMgdG8gZGVmaW5pdGlvbiBpbiB0aGF0IG5hbWVzcGFjZS5cblx0XHRcdFx0dmFyIHBhcmVudFR5cGUgPSBzY29wZS5nZXRQYXJlbnRUeXBlKG90aGVyTmFtZXNwYWNlKTtcblx0XHRcdFx0aWYocGFyZW50VHlwZSkge1xuXHRcdFx0XHRcdG91dFR5cGUuY29udGFpbmluZ1R5cGUgPSBwYXJlbnRUeXBlLmdldE91dFR5cGUoY29udGV4dCk7XG5cdFx0XHRcdH1cblxuXHRcdFx0XHRleHBvcnRUeXBlKHR5cGUsIG91dE1lbWJlci5uYW1lc3BhY2UsIGNvbnRleHQpO1xuXHRcdFx0fVxuXG5cdFx0XHRyZXR1cm4ob3V0VHlwZSk7XG5cdFx0fVxuXHQpO1xuXG5cdG91dE1lbWJlci5pc0Fic3RyYWN0ID0gbWVtYmVyLmlzQWJzdHJhY3QoKTtcblxuXHRpZihtZW1iZXIgaW5zdGFuY2VvZiB0eXBlcy5FbGVtZW50KSB7XG5cdFx0aWYobWVtYmVyLnN1YnN0aXR1dGVzKSB7XG5cdFx0XHRvdXRNZW1iZXIuc3Vic3RpdHV0ZXMgPSBtZW1iZXIuc3Vic3RpdHV0ZXMuZ2V0T3V0TWVtYmVyKGNvbnRleHQpO1xuXHRcdFx0b3V0TWVtYmVyLm5hbWVzcGFjZS5wZW5kaW5nU3Vic3RpdHV0ZUxpc3QucHVzaChvdXRNZW1iZXIpO1xuXHRcdH1cblx0XHRpZihtZW1iZXIuaXNTdWJzdGl0dXRlZCkgb3V0TWVtYmVyLmlzU3Vic3RpdHV0ZWQgPSB0cnVlO1xuXHR9XG59XG5cbmZ1bmN0aW9uIGV4cG9ydEF0dHJpYnV0ZXMoc2NvcGU6IFNjb3BlLCBuYW1lc3BhY2U6IHNjaGVtYS5OYW1lc3BhY2UsIGNvbnRleHQ6IHNjaGVtYS5Db250ZXh0LCB0eXBlOiBzY2hlbWEuVHlwZSkge1xuXHR2YXIgbWVtYmVyVGJsID0gc2NvcGUuZHVtcE1lbWJlcnMoJ2F0dHJpYnV0ZScsICdhdHRyaWJ1dGVHcm91cCcpO1xuXG5cdGZvcih2YXIga2V5IG9mIE9iamVjdC5rZXlzKG1lbWJlclRibCkuc29ydCgpKSB7XG5cdFx0dmFyIHJlZiA9IGV4cG9ydE1lbWJlclJlZihtZW1iZXJUYmxba2V5XSwgc2NvcGUsIG5hbWVzcGFjZSwgY29udGV4dCk7XG5cdFx0dHlwZS5hZGRBdHRyaWJ1dGUocmVmKTtcblx0fVxufVxuXG5mdW5jdGlvbiBleHBvcnRDaGlsZHJlbihcblx0c2NvcGU6IFNjb3BlLFxuXHRuYW1lc3BhY2U6IHNjaGVtYS5OYW1lc3BhY2UsXG5cdGNvbnRleHQ6IHNjaGVtYS5Db250ZXh0LFxuXHRvdXRUeXBlOiBzY2hlbWEuVHlwZSxcblx0c2V0RXhwb3J0ZWQ6IGJvb2xlYW5cbikge1xuXHR2YXIgbWVtYmVyVGJsID0gc2NvcGUuZHVtcE1lbWJlcnMoJ2VsZW1lbnQnLCAnZ3JvdXAnKTtcblxuXHRmb3IodmFyIGtleSBvZiBPYmplY3Qua2V5cyhtZW1iZXJUYmwpLnNvcnQoKSkge1xuXHRcdHZhciByZWYgPSBleHBvcnRNZW1iZXJSZWYobWVtYmVyVGJsW2tleV0sIHNjb3BlLCBuYW1lc3BhY2UsIGNvbnRleHQpO1xuXG5cdFx0aWYoc2V0RXhwb3J0ZWQpIHJlZi5tZW1iZXIuaXNFeHBvcnRlZCA9IHRydWU7XG5cdFx0b3V0VHlwZS5hZGRDaGlsZChyZWYpO1xuXHR9XG59XG5cbi8qIFRPRE9cbmZ1bmN0aW9uIGV4cG9ydEdyb3VwcyhzY29wZTogU2NvcGUsIG5hbWVzcGFjZTogc2NoZW1hLk5hbWVzcGFjZSwgY29udGV4dDogc2NoZW1hLkNvbnRleHQpIHtcbi8vXHR2YXIgZ3JvdXBUYmwgPSBzY29wZS5kdW1wR3JvdXBzKCk7XG5cdHZhciBncm91cExpc3Q6IHNjaGVtYS5NZW1iZXJbXSA9IFtdO1xuXG5cdHJldHVybihncm91cExpc3QpO1xufVxuKi9cblxuZnVuY3Rpb24gZXhwb3J0VHlwZSh0eXBlOiB0eXBlcy5UeXBlQmFzZSwgbmFtZXNwYWNlOiBzY2hlbWEuTmFtZXNwYWNlLCBjb250ZXh0OiBzY2hlbWEuQ29udGV4dCkge1xuXHR2YXIgc2NvcGUgPSB0eXBlLmdldFNjb3BlKCk7XG5cdHZhciBjb21tZW50ID0gc2NvcGUuZ2V0Q29tbWVudHMoKTtcblxuXHR0eXBlLmV4cG9ydGVkID0gdHJ1ZTtcblxuXHR2YXIgb3V0VHlwZSA9IHR5cGUuZ2V0T3V0VHlwZShjb250ZXh0KTtcblx0b3V0VHlwZS5jb21tZW50ID0gY29tbWVudDtcblx0b3V0VHlwZS5ieXRlUG9zID0gdHlwZS5ieXRlUG9zO1xuXHQvLyBJZiB0aGUgdHlwZSBkZXJpdmVzIGZyb20gYSBwcmltaXRpdmUgdHlwZSwgaXQgbWF5IGhhdmUgdGV4dCBjb250ZW50LlxuXHR2YXIgcGFyZW50UHJpbWl0aXZlID0gdHlwZS5nZXRQYXJlbnQodHlwZXMuUHJpbWl0aXZlLCBmYWxzZSk7XG5cblx0aWYocGFyZW50UHJpbWl0aXZlKSB7XG5cdFx0Ly8gR2V0IGVxdWl2YWxlbnQgSmF2YVNjcmlwdCB0eXBlLlxuXHRcdG91dFR5cGUucHJpbWl0aXZlVHlwZSA9IHBhcmVudFByaW1pdGl2ZS5nZXRPdXRUeXBlKGNvbnRleHQpO1xuXG5cdFx0Ly8gQ2hlY2sgaWYgcHJpbWl0aXZlIHR5cGUgaXMgaW5oZXJpdGVkIHdpdGhvdXQgYW55IGFkZGl0aW9uYWwgYXR0cmlidXRlc1xuXHRcdC8vIG9yIGNoaWxkcmVuLCBzbyBjb250ZW50cyBjYW4gYmUgcmVwcmVzZW50ZWQgYXMgYSBKYXZhU2NyaXB0IHByaW1pdGl2ZS5cblx0XHQvLyBOT1RFOiBTdWJzdGl0dXRpb25zIHdvbid0IGJlIGFwcGxpZWQgdG8gc3VjaCB0eXBlcyFcblx0XHRwYXJlbnRQcmltaXRpdmUgPSB0eXBlLmdldFBhcmVudCh0eXBlcy5QcmltaXRpdmUsIHRydWUpO1xuXHR9XG5cblx0aWYocGFyZW50UHJpbWl0aXZlKSB7XG5cdFx0dmFyIGxpdGVyYWxMaXN0OiBzdHJpbmdbXTtcblx0XHR2YXIgcGFyZW50U2ltcGxlID0gdHlwZS5nZXRQYXJlbnQodHlwZXMuU2ltcGxlVHlwZSwgZmFsc2UpIGFzIHR5cGVzLlNpbXBsZVR5cGU7XG5cblx0XHRpZihwYXJlbnRTaW1wbGUpIHtcblx0XHRcdC8vIElmIHBhcmVudCBpcyByZXN0cmljdGVkIHRvIGVudW1lcmF0ZWQgYWx0ZXJuYXRpdmVzLCBvdXRwdXQgdGhvc2UgaW5zdGVhZC5cblx0XHRcdGxpdGVyYWxMaXN0ID0gcGFyZW50U2ltcGxlLmdldEVudW1lcmF0aW9uTGlzdCgpO1xuXHRcdFx0aWYobGl0ZXJhbExpc3QpIGxpdGVyYWxMaXN0ID0gbGl0ZXJhbExpc3QubWFwKChjb250ZW50OiBzdHJpbmcpID0+ICdcIicgKyBjb250ZW50ICsgJ1wiJyk7XG5cdFx0fVxuXG5cdFx0b3V0VHlwZS5saXRlcmFsTGlzdCA9IGxpdGVyYWxMaXN0O1xuXHRcdG91dFR5cGUuaXNQbGFpblByaW1pdGl2ZSA9IHRydWU7XG5cdFx0b3V0VHlwZS5wcmltaXRpdmVUeXBlID0gcGFyZW50UHJpbWl0aXZlLmdldE91dFR5cGUoY29udGV4dCk7XG5cdH1cblxuXHR2YXIgcGFyZW50ID0gdHlwZS5wYXJlbnQ7XG5cblx0aWYocGFyZW50IGluc3RhbmNlb2YgdHlwZXMuVHlwZUJhc2UgJiYgcGFyZW50ICE9IHBhcmVudFByaW1pdGl2ZSkge1xuXHRcdG91dFR5cGUucGFyZW50ID0gcGFyZW50LmdldE91dFR5cGUoY29udGV4dCk7XG5cdH1cblxuXHRleHBvcnRBdHRyaWJ1dGVzKHNjb3BlLCBuYW1lc3BhY2UsIGNvbnRleHQsIG91dFR5cGUpO1xuXHRleHBvcnRDaGlsZHJlbihzY29wZSwgbmFtZXNwYWNlLCBjb250ZXh0LCBvdXRUeXBlLCBmYWxzZSk7XG4vL1x0b3V0VHlwZS5ncm91cExpc3QgPSBleHBvcnRHcm91cHMoc2NvcGUsIG5hbWVzcGFjZSwgY29udGV4dCk7XG5cblx0dmFyIGxpc3RUeXBlID0gdHlwZS5nZXRMaXN0VHlwZSgpO1xuXG5cdGlmKGxpc3RUeXBlKSB7XG5cdFx0Zm9yKHZhciBzcGVjIG9mIGxpc3RUeXBlKSB7XG5cdFx0XHR2YXIgb3V0TWVtYmVyID0gbmV3IHNjaGVtYS5NZW1iZXIoJycpO1xuXHRcdFx0dmFyIG91dE1lbWJlclJlZiA9IG5ldyBzY2hlbWEuTWVtYmVyUmVmKG91dE1lbWJlciwgc3BlYy5taW4sIHNwZWMubWF4KTtcblxuXHRcdFx0b3V0TWVtYmVyLm5hbWVzcGFjZSA9IG5hbWVzcGFjZTtcblx0XHRcdG91dE1lbWJlci50eXBlTGlzdCA9IFtcblx0XHRcdFx0ZXhwb3J0VHlwZShzcGVjLml0ZW0gYXMgdHlwZXMuVHlwZUJhc2UsIG5hbWVzcGFjZSwgY29udGV4dClcblx0XHRcdF07XG5cblx0XHRcdG91dFR5cGUuYWRkQ2hpbGQob3V0TWVtYmVyUmVmKTtcblx0XHR9XG5cblx0XHRvdXRUeXBlLmlzTGlzdCA9IHRydWU7XG5cdH1cblxuXHRyZXR1cm4ob3V0VHlwZSk7XG59XG5cbi8qKiBFeHBvcnQgcGFyc2VkIHhzZCBpbnRvIGEgc2ltcGxlciBpbnRlcm5hbCBzY2hlbWEgZm9ybWF0LiAqL1xuXG5leHBvcnQgZnVuY3Rpb24gZXhwb3J0TmFtZXNwYWNlKG5hbWVzcGFjZTogTmFtZXNwYWNlLCBjb250ZXh0OiBzY2hlbWEuQ29udGV4dCk6IHNjaGVtYS5UeXBlIHtcblx0dmFyIG91dE5hbWVzcGFjZSA9IGNvbnRleHQuY29weU5hbWVzcGFjZShuYW1lc3BhY2UpO1xuXHR2YXIgZG9jID0gb3V0TmFtZXNwYWNlLmRvYztcblxuXHRpZihkb2MpIHJldHVybihkb2MpO1xuXG4vL1x0aWYoIWRvYykge1xuXHRcdHZhciBzY29wZSA9IG5hbWVzcGFjZS5nZXRTY29wZSgpO1xuXG5cdFx0dmFyIHNvdXJjZUxpc3QgPSBuYW1lc3BhY2UuZ2V0U291cmNlTGlzdCgpO1xuXHRcdHZhciBpbXBvcnRUYmw6IHsgW2lkOiBzdHJpbmddOiBOYW1lc3BhY2UgfSA9IHt9XG5cblx0XHRmb3IodmFyIHNvdXJjZSBvZiBzb3VyY2VMaXN0KSB7XG5cdFx0XHR2YXIgbmFtZXNwYWNlUmVmVGJsID0gc291cmNlLmdldE5hbWVzcGFjZVJlZnMoKTtcblxuXHRcdFx0Zm9yKHZhciBuYW1lIG9mIE9iamVjdC5rZXlzKG5hbWVzcGFjZVJlZlRibCkpIHtcblx0XHRcdFx0dmFyIG90aGVyTmFtZXNwYWNlID0gbmFtZXNwYWNlUmVmVGJsW25hbWVdO1xuXG5cdFx0XHRcdG91dE5hbWVzcGFjZS5hZGRSZWYobmFtZSwgY29udGV4dC5jb3B5TmFtZXNwYWNlKG90aGVyTmFtZXNwYWNlKSk7XG5cblx0XHRcdFx0aW1wb3J0VGJsW290aGVyTmFtZXNwYWNlLmlkXSA9IG90aGVyTmFtZXNwYWNlO1xuXHRcdFx0fVxuXHRcdH1cblxuXHRcdG91dE5hbWVzcGFjZS5zb3VyY2VMaXN0ID0gc291cmNlTGlzdC5tYXAoKHNvdXJjZTogU291cmNlKSA9PiBzb3VyY2UudXJsKS5zb3J0KCk7XG5cblx0XHRmb3IodmFyIHNwZWMgb2Ygc2NvcGUuZHVtcFR5cGVzKCd0eXBlJykgfHwgW10pIHtcblx0XHRcdGlmKHNwZWMubmFtZSkgZXhwb3J0VHlwZShzcGVjLml0ZW0gYXMgdHlwZXMuVHlwZUJhc2UsIG91dE5hbWVzcGFjZSwgY29udGV4dCkuaXNFeHBvcnRlZCA9IHRydWU7XG5cdFx0fVxuXG5cdFx0ZG9jID0gbmV3IHNjaGVtYS5UeXBlKG51bGwpO1xuXG5cdFx0ZG9jLm5hbWVzcGFjZSA9IG91dE5hbWVzcGFjZTtcblx0XHRleHBvcnRBdHRyaWJ1dGVzKHNjb3BlLCBvdXROYW1lc3BhY2UsIGNvbnRleHQsIGRvYyk7XG5cdFx0ZXhwb3J0Q2hpbGRyZW4oc2NvcGUsIG91dE5hbWVzcGFjZSwgY29udGV4dCwgZG9jLCB0cnVlKTtcblxuXHRcdG91dE5hbWVzcGFjZS5kb2MgPSBkb2M7XG5cblx0XHRmb3IodmFyIG5hbWVzcGFjZUlkIG9mIE9iamVjdC5rZXlzKGltcG9ydFRibCkpIHtcblx0XHRcdGV4cG9ydE5hbWVzcGFjZShpbXBvcnRUYmxbbmFtZXNwYWNlSWRdLCBjb250ZXh0KTtcblx0XHR9XG5cblx0XHRmb3IodmFyIG1lbWJlciBvZiBvdXROYW1lc3BhY2UucGVuZGluZ1N1YnN0aXR1dGVMaXN0KSB7XG5cdFx0XHR2YXIgcHJveHkgPSBtZW1iZXIuc3Vic3RpdHV0ZXMuZ2V0UHJveHkoKTtcblxuXHRcdFx0aWYobWVtYmVyLnN1YnN0aXR1dGVzLm5hbWVzcGFjZSA9PSBtZW1iZXIubmFtZXNwYWNlKSB7XG5cdFx0XHRcdGlmKG1lbWJlci5pc1N1YnN0aXR1dGVkIHx8IG1lbWJlci5pc0Fic3RyYWN0KSB7XG5cdFx0XHRcdFx0cHJveHkuYWRkTWl4aW4obWVtYmVyLmdldFByb3h5KCkpO1xuXHRcdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRcdHByb3h5LmFkZENoaWxkU3BlYyhtZW1iZXIpO1xuXHRcdFx0XHR9XG5cdFx0XHR9IGVsc2Uge1xuXHRcdFx0XHRtZW1iZXIubmFtZXNwYWNlLmFkZEF1Z21lbnRhdGlvbihwcm94eSwgbWVtYmVyKTtcblx0XHRcdH1cblx0XHR9XG4vL1x0fVxuXG5cdHJldHVybihkb2MpO1xufVxuIl19