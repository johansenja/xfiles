"use strict";
// This file is part of cxml, copyright (c) 2016 BusFaster Ltd.
// Released under the MIT license, see LICENSE.
Object.defineProperty(exports, "__esModule", { value: true });
exports.Parser = void 0;
var Promise = require("bluebird");
var sax = require("sax");
var State_1 = require("./State");
var JS_1 = require("../importer/JS");
var converterTbl = {
    Date: function (item) {
        var dateParts = item.match(/([0-9]+)-([0-9]+)-([0-9]+)(?:T([0-9]+):([0-9]+):([0-9]+)(\.[0-9]+)?)?(?:Z|([+-][0-9]+):([0-9]+))?/);
        var offsetMinutes = +(dateParts[9] || "0");
        var offset = +(dateParts[8] || "0") * 60;
        if (offset < 0)
            offsetMinutes = -offsetMinutes;
        offset += offsetMinutes;
        var date = new Date(+dateParts[1], +dateParts[2] - 1, +dateParts[3], +(dateParts[4] || "0"), +(dateParts[5] || "0"), +(dateParts[6] || "0"), +(dateParts[7] || "0") * 1000);
        date.setTime(date.getTime() - (offset + date.getTimezoneOffset()) * 60000);
        date.cxmlTimezoneOffset = offset;
        return date;
    },
    boolean: function (item) { return item == "true"; },
    string: function (item) { return item; },
    number: function (item) { return +item; },
};
function convertPrimitive(text, type) {
    var converter = converterTbl[type.primitiveType];
    if (converter) {
        if (type.isList) {
            return text.trim().split(/\s+/).map(converter);
        }
        else {
            return converter(text.trim());
        }
    }
    return null;
}
var Parser = /** @class */ (function () {
    function Parser() {
    }
    Parser.prototype.attach = function (handler) {
        var proto = handler.prototype;
        var realHandler = handler.type.handler;
        var realProto = realHandler.prototype;
        for (var _i = 0, _a = Object.keys(proto); _i < _a.length; _i++) {
            var key = _a[_i];
            realProto[key] = proto[key];
        }
        realHandler._custom = true;
    };
    Parser.prototype.parse = function (stream, output, context) {
        var _this = this;
        return new Promise(function (resolve, reject) {
            return _this._parse(stream, output, context, resolve, reject);
        });
    };
    Parser.prototype._parse = function (stream, output, context, resolve, reject) {
        var _this = this;
        this.context = context || JS_1.defaultContext;
        var xml = sax.createStream(true, { position: true });
        var type = output.constructor.type;
        var xmlSpace = this.context.registerNamespace("http://www.w3.org/XML/1998/namespace");
        var state = new State_1.State(null, null, type, new type.handler());
        var rootState = state;
        state.addNamespace("", type.namespace);
        if (xmlSpace)
            state.addNamespace("xml", xmlSpace);
        xml.on("opentag", function (node) {
            var attrTbl = node.attributes;
            var attr;
            var nodePrefix = "";
            var name = node.name;
            var splitter = name.indexOf(":");
            var item = null;
            // Read xmlns namespace prefix definitions before parsing node name.
            for (var _i = 0, _a = Object.keys(attrTbl); _i < _a.length; _i++) {
                var key = _a[_i];
                if (key.substr(0, 5) == "xmlns") {
                    var nsParts = key.match(/^xmlns(:(.+))?$/);
                    if (nsParts) {
                        state.addNamespace(nsParts[2] || "", _this.context.registerNamespace(attrTbl[key]));
                    }
                }
            }
            // Parse node name and possible namespace prefix.
            if (splitter >= 0) {
                nodePrefix = name.substr(0, splitter);
                name = name.substr(splitter + 1);
            }
            // Add internal surrogate key namespace prefix to node name.
            var nodeNamespace = state.namespaceTbl[nodePrefix];
            name = nodeNamespace[1] + name;
            var child;
            var type;
            if (state.type) {
                child = state.type.childTbl[name];
                if (child) {
                    if (child.proxy) {
                        type = child.proxy.member.type;
                        state = new State_1.State(state, child.proxy, type, new type.handler());
                    }
                    type = child.member.type;
                }
            }
            if (type && !type.isPlainPrimitive) {
                item = new type.handler();
                // Parse all attributes.
                for (var _b = 0, _c = Object.keys(attrTbl); _b < _c.length; _b++) {
                    var key = _c[_b];
                    splitter = key.indexOf(":");
                    if (splitter >= 0) {
                        var attrPrefix = key.substr(0, splitter);
                        if (attrPrefix == "xmlns")
                            continue;
                        var attrNamespace = state.namespaceTbl[attrPrefix];
                        if (attrNamespace) {
                            attr = attrNamespace[1] + key.substr(splitter + 1);
                        }
                        else {
                            console.log("Namespace not found for " + key);
                            continue;
                        }
                    }
                    else {
                        attr = nodeNamespace[1] + key;
                    }
                    var ref = type.attributeTbl[attr];
                    if (ref && ref.member.type.isPlainPrimitive) {
                        item[ref.safeName] = convertPrimitive(attrTbl[key], ref.member.type);
                    }
                }
                if (item._before)
                    item._before();
            }
            state = new State_1.State(state, child, type, item);
        });
        xml.on("text", function (text) {
            if (state.type && state.type.isPrimitive) {
                if (!state.textList)
                    state.textList = [];
                state.textList.push(text);
            }
        });
        xml.on("closetag", function (name) {
            var member = state.memberRef;
            var obj = state.item;
            var item = obj;
            var text;
            if (state.type && state.type.isPrimitive)
                text = (state.textList || []).join("").trim();
            if (text) {
                var content = convertPrimitive(text, state.type);
                if (state.type.isPlainPrimitive)
                    item = content;
                else
                    obj.content = content;
            }
            if (obj && obj._after)
                obj._after();
            state = state.parent;
            if (member && member.proxy) {
                if (item)
                    state.item[member.safeName] = item;
                item = state.item;
                state = state.parent;
                member = member.proxy;
            }
            if (item) {
                var parent = state.item;
                if (parent) {
                    if (member.max > 1) {
                        if (!parent.hasOwnProperty(member.safeName))
                            parent[member.safeName] = [];
                        parent[member.safeName].push(item);
                    }
                    else
                        parent[member.safeName] = item;
                }
            }
        });
        xml.on("end", function () {
            resolve(rootState.item);
        });
        xml.on("error", function (err) {
            console.error(err);
        });
        if (typeof stream == "string") {
            xml.write(stream);
            xml.end();
        }
        else
            stream.pipe(xml);
    };
    return Parser;
}());
exports.Parser = Parser;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiUGFyc2VyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vcnVudGltZV9wYXJzZXIvc3JjL3htbC9QYXJzZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLCtEQUErRDtBQUMvRCwrQ0FBK0M7OztBQUcvQyxrQ0FBb0M7QUFDcEMseUJBQTJCO0FBSzNCLGlDQUFnQztBQUNoQyxxQ0FBZ0Q7QUFNaEQsSUFBSSxZQUFZLEdBQThDO0lBQzVELElBQUksRUFBRSxVQUFDLElBQVk7UUFDakIsSUFBSSxTQUFTLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FDeEIsbUdBQW1HLENBQ3BHLENBQUM7UUFDRixJQUFJLGFBQWEsR0FBRyxDQUFDLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxJQUFJLEdBQUcsQ0FBQyxDQUFDO1FBQzNDLElBQUksTUFBTSxHQUFHLENBQUMsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLElBQUksR0FBRyxDQUFDLEdBQUcsRUFBRSxDQUFDO1FBRXpDLElBQUksTUFBTSxHQUFHLENBQUM7WUFBRSxhQUFhLEdBQUcsQ0FBQyxhQUFhLENBQUM7UUFFL0MsTUFBTSxJQUFJLGFBQWEsQ0FBQztRQUV4QixJQUFJLElBQUksR0FBRyxJQUFJLElBQUksQ0FDakIsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLEVBQ2IsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxFQUNqQixDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsRUFDYixDQUFDLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxJQUFJLEdBQUcsQ0FBQyxFQUN0QixDQUFDLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxJQUFJLEdBQUcsQ0FBQyxFQUN0QixDQUFDLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxJQUFJLEdBQUcsQ0FBQyxFQUN0QixDQUFDLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxJQUFJLEdBQUcsQ0FBQyxHQUFHLElBQUksQ0FD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LENBQUMsR0FBRyxDQUFDLENBQUM7SUFDL0MsQ0FBQztJQUdILGFBQUM7QUFBRCxDQUFDLEFBek1ELElBeU1DO0FBek1ZLHdCQUFNIiwic291cmNlc0NvbnRlbnQiOlsiLy8gVGhpcyBmaWxlIGlzIHBhcnQgb2YgY3htbCwgY29weXJpZ2h0IChjKSAyMDE2IEJ1c0Zhc3RlciBMdGQuXG4vLyBSZWxlYXNlZCB1bmRlciB0aGUgTUlUIGxpY2Vuc2UsIHNlZSBMSUNFTlNFLlxuXG5pbXBvcnQgKiBhcyBzdHJlYW0gZnJvbSBcInN0cmVhbVwiO1xuaW1wb3J0ICogYXMgUHJvbWlzZSBmcm9tIFwiYmx1ZWJpcmRcIjtcbmltcG9ydCAqIGFzIHNheCBmcm9tIFwic2F4XCI7XG5cbmltcG9ydCB7IENvbnRleHQgfSBmcm9tIFwiLi9Db250ZXh0XCI7XG5pbXBvcnQgeyBUeXBlLCBUeXBlQ2xhc3MsIEhhbmRsZXJJbnN0YW5jZSB9IGZyb20gXCIuL1R5cGVcIjtcbmltcG9ydCB7IE1lbWJlclJlZiB9IGZyb20gXCIuL01lbWJlclJlZlwiO1xuaW1wb3J0IHsgU3RhdGUgfSBmcm9tIFwiLi9TdGF0ZVwiO1xuaW1wb3J0IHsgZGVmYXVsdENvbnRleHQgfSBmcm9tIFwiLi4vaW1wb3J0ZXIvSlNcIjtcblxuZXhwb3J0IGludGVyZmFjZSBDeG1sRGF0ZSBleHRlbmRzIERhdGUge1xuICBjeG1sVGltZXpvbmVPZmZzZXQ6IG51bWJlcjtcbn1cblxudmFyIGNvbnZlcnRlclRibDogeyBbdHlwZTogc3RyaW5nXTogKGl0ZW06IHN0cmluZykgPT4gYW55IH0gPSB7XG4gIERhdGU6IChpdGVtOiBzdHJpbmcpID0+IHtcbiAgICB2YXIgZGF0ZVBhcnRzID0gaXRlbS5tYXRjaChcbiAgICAgIC8oWzAtOV0rKS0oWzAtOV0rKS0oWzAtOV0rKSg/OlQoWzAtOV0rKTooWzAtOV0rKTooWzAtOV0rKShcXC5bMC05XSspPyk/KD86WnwoWystXVswLTldKyk6KFswLTldKykpPy9cbiAgICApO1xuICAgIHZhciBvZmZzZXRNaW51dGVzID0gKyhkYXRlUGFydHNbOV0gfHwgXCIwXCIpO1xuICAgIHZhciBvZmZzZXQgPSArKGRhdGVQYXJ0c1s4XSB8fCBcIjBcIikgKiA2MDtcblxuICAgIGlmIChvZmZzZXQgPCAwKSBvZmZzZXRNaW51dGVzID0gLW9mZnNldE1pbnV0ZXM7XG5cbiAgICBvZmZzZXQgKz0gb2Zmc2V0TWludXRlcztcblxuICAgIHZhciBkYXRlID0gbmV3IERhdGUoXG4gICAgICArZGF0ZVBhcnRzWzFdLFxuICAgICAgK2RhdGVQYXJ0c1syXSAtIDEsXG4gICAgICArZGF0ZVBhcnRzWzNdLFxuICAgICAgKyhkYXRlUGFydHNbNF0gfHwgXCIwXCIpLFxuICAgICAgKyhkYXRlUGFydHNbNV0gfHwgXCIwXCIpLFxuICAgICAgKyhkYXRlUGFydHNbNl0gfHwgXCIwXCIpLFxuICAgICAgKyhkYXRlUGFydHNbN10gfHwgXCIwXCIpICogMTAwMFxuICAgICkgYXMgQ3htbERhdGU7XG5cbiAgICBkYXRlLnNldFRpbWUoZGF0ZS5nZXRUaW1lKCkgLSAob2Zmc2V0ICsgZGF0ZS5nZXRUaW1lem9uZU9mZnNldCgpKSAqIDYwMDAwKTtcbiAgICBkYXRlLmN4bWxUaW1lem9uZU9mZnNldCA9IG9mZnNldDtcblxuICAgIHJldHVybiBkYXRlO1xuICB9LFxuICBib29sZWFuOiAoaXRlbTogc3RyaW5nKSA9PiBpdGVtID09IFwidHJ1ZVwiLFxuICBzdHJpbmc6IChpdGVtOiBzdHJpbmcpID0+IGl0ZW0sXG4gIG51bWJlcjogKGl0ZW06IHN0cmluZykgPT4gK2l0ZW0sXG59O1xuXG5mdW5jdGlvbiBjb252ZXJ0UHJpbWl0aXZlKHRleHQ6IHN0cmluZywgdHlwZTogVHlwZSkge1xuICB2YXIgY29udmVydGVyID0gY29udmVydGVyVGJsW3R5cGUucHJpbWl0aXZlVHlwZV07XG5cbiAgaWYgKGNvbnZlcnRlcikge1xuICAgIGlmICh0eXBlLmlzTGlzdCkge1xuICAgICAgcmV0dXJuIHRleHQudHJpbSgpLnNwbGl0KC9cXHMrLykubWFwKGNvbnZlcnRlcik7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJldHVybiBjb252ZXJ0ZXIodGV4dC50cmltKCkpO1xuICAgIH1cbiAgfVxuXG4gIHJldHVybiBudWxsO1xufVxuXG5leHBvcnQgY2xhc3MgUGFyc2VyIHtcbiAgYXR0YWNoPEN1c3RvbUhhbmRsZXIgZXh0ZW5kcyBIYW5kbGVySW5zdGFuY2U+KGhhbmRsZXI6IHtcbiAgICBuZXcgKCk6IEN1c3RvbUhhbmRsZXI7XG4gIH0pIHtcbiAgICB2YXIgcHJvdG8gPSBoYW5kbGVyLnByb3RvdHlwZSBhcyBDdXN0b21IYW5kbGVyO1xuICAgIHZhciByZWFsSGFuZGxlciA9IChoYW5kbGVyIGFzIFR5cGVDbGFzcykudHlwZS5oYW5kbGVyO1xuICAgIHZhciByZWFsUHJvdG8gPSByZWFsSGFuZGxlci5wcm90b3R5cGUgYXMgQ3VzdG9tSGFuZGxlcjtcblxuICAgIGZvciAodmFyIGtleSBvZiBPYmplY3Qua2V5cyhwcm90bykpIHtcbiAgICAgIHJlYWxQcm90b1trZXkgYXMga2V5b2YgQ3VzdG9tSGFuZGxlcl0gPSBwcm90b1trZXldO1xuICAgIH1cblxuICAgIHJlYWxIYW5kbGVyLl9jdXN0b20gPSB0cnVlO1xuICB9XG5cbiAgcGFyc2U8T3V0cHV0IGV4dGVuZHMgSGFuZGxlckluc3RhbmNlPihcbiAgICBzdHJlYW06IHN0cmluZyB8IHN0cmVhbS5SZWFkYWJsZSB8IE5vZGVKUy5SZWFkYWJsZVN0cmVhbSxcbiAgICBvdXRwdXQ6IE91dHB1dCxcbiAgICBjb250ZXh0PzogQ29udGV4dFxuICApIHtcbiAgICByZXR1cm4gbmV3IFByb21pc2U8T3V0cHV0PihcbiAgICAgIChyZXNvbHZlOiAoaXRlbTogT3V0cHV0KSA9PiB2b2lkLCByZWplY3Q6IChlcnI6IGFueSkgPT4gdm9pZCkgPT5cbiAgICAgICAgdGhpcy5fcGFyc2U8T3V0cHV0PihzdHJlYW0sIG91dHB1dCwgY29udGV4dCwgcmVzb2x2ZSwgcmVqZWN0KVxuICAgICk7XG4gIH1cblxuICBfcGFyc2U8T3V0cHV0IGV4dGVuZHMgSGFuZGxlckluc3RhbmNlPihcbiAgICBzdHJlYW06IHN0cmluZyB8IHN0cmVhbS5SZWFkYWJsZSB8IE5vZGVKUy5SZWFkYWJsZVN0cmVhbSxcbiAgICBvdXRwdXQ6IE91dHB1dCxcbiAgICBjb250ZXh0OiBDb250ZXh0LFxuICAgIHJlc29sdmU6IChpdGVtOiBPdXRwdXQpID0+IHZvaWQsXG4gICAgcmVqZWN0OiAoZXJyOiBhbnkpID0+IHZvaWRcbiAgKSB7XG4gICAgdGhpcy5jb250ZXh0ID0gY29udGV4dCB8fCBkZWZhdWx0Q29udGV4dDtcblxuICAgIHZhciB4bWwgPSBzYXguY3JlYXRlU3RyZWFtKHRydWUsIHsgcG9zaXRpb246IHRydWUgfSk7XG4gICAgdmFyIHR5cGUgPSAob3V0cHV0LmNvbnN0cnVjdG9yIGFzIFR5cGVDbGFzcykudHlwZTtcblxuICAgIHZhciB4bWxTcGFjZSA9IHRoaXMuY29udGV4dC5yZWdpc3Rlck5hbWVzcGFjZShcbiAgICAgIFwiaHR0cDovL3d3dy53My5vcmcvWE1MLzE5OTgvbmFtZXNwYWNlXCJcbiAgICApO1xuICAgIHZhciBzdGF0ZSA9IG5ldyBTdGF0ZShudWxsLCBudWxsLCB0eXBlLCBuZXcgdHlwZS5oYW5kbGVyKCkpO1xuICAgIHZhciByb290U3RhdGUgPSBzdGF0ZTtcblxuICAgIHN0YXRlLmFkZE5hbWVzcGFjZShcIlwiLCB0eXBlLm5hbWVzcGFjZSk7XG4gICAgaWYgKHhtbFNwYWNlKSBzdGF0ZS5hZGROYW1lc3BhY2UoXCJ4bWxcIiwgeG1sU3BhY2UpO1xuXG4gICAgeG1sLm9uKFwib3BlbnRhZ1wiLCAobm9kZTogc2F4LlRhZykgPT4ge1xuICAgICAgdmFyIGF0dHJUYmwgPSBub2RlLmF0dHJpYnV0ZXM7XG4gICAgICB2YXIgYXR0cjogc3RyaW5nO1xuICAgICAgdmFyIG5vZGVQcmVmaXggPSBcIlwiO1xuICAgICAgdmFyIG5hbWUgPSBub2RlLm5hbWU7XG4gICAgICB2YXIgc3BsaXR0ZXIgPSBuYW1lLmluZGV4T2YoXCI6XCIpO1xuICAgICAgdmFyIGl0ZW06IEhhbmRsZXJJbnN0YW5jZSA9IG51bGw7XG5cbiAgICAgIC8vIFJlYWQgeG1sbnMgbmFtZXNwYWNlIHByZWZpeCBkZWZpbml0aW9ucyBiZWZvcmUgcGFyc2luZyBub2RlIG5hbWUuXG5cbiAgICAgIGZvciAodmFyIGtleSBvZiBPYmplY3Qua2V5cyhhdHRyVGJsKSkge1xuICAgICAgICBpZiAoa2V5LnN1YnN0cigwLCA1KSA9PSBcInhtbG5zXCIpIHtcbiAgICAgICAgICB2YXIgbnNQYXJ0cyA9IGtleS5tYXRjaCgvXnhtbG5zKDooLispKT8kLyk7XG5cbiAgICAgICAgICBpZiAobnNQYXJ0cykge1xuICAgICAgICAgICAgc3RhdGUuYWRkTmFtZXNwYWNlKFxuICAgICAgICAgICAgICBuc1BhcnRzWzJdIHx8IFwiXCIsXG4gICAgICAgICAgICAgIHRoaXMuY29udGV4dC5yZWdpc3Rlck5hbWVzcGFjZShhdHRyVGJsW2tleV0pXG4gICAgICAgICAgICApO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICAvLyBQYXJzZSBub2RlIG5hbWUgYW5kIHBvc3NpYmxlIG5hbWVzcGFjZSBwcmVmaXguXG5cbiAgICAgIGlmIChzcGxpdHRlciA+PSAwKSB7XG4gICAgICAgIG5vZGVQcmVmaXggPSBuYW1lLnN1YnN0cigwLCBzcGxpdHRlcik7XG4gICAgICAgIG5hbWUgPSBuYW1lLnN1YnN0cihzcGxpdHRlciArIDEpO1xuICAgICAgfVxuXG4gICAgICAvLyBBZGQgaW50ZXJuYWwgc3Vycm9nYXRlIGtleSBuYW1lc3BhY2UgcHJlZml4IHRvIG5vZGUgbmFtZS5cblxuICAgICAgdmFyIG5vZGVOYW1lc3BhY2UgPSBzdGF0ZS5uYW1lc3BhY2VUYmxbbm9kZVByZWZpeF07XG4gICAgICBuYW1lID0gbm9kZU5hbWVzcGFjZVsxXSArIG5hbWU7XG5cbiAgICAgIHZhciBjaGlsZDogTWVtYmVyUmVmO1xuICAgICAgdmFyIHR5cGU6IFR5cGU7XG5cbiAgICAgIGlmIChzdGF0ZS50eXBlKSB7XG4gICAgICAgIGNoaWxkID0gc3RhdGUudHlwZS5jaGlsZFRibFtuYW1lXTtcblxuICAgICAgICBpZiAoY2hpbGQpIHtcbiAgICAgICAgICBpZiAoY2hpbGQucHJveHkpIHtcbiAgICAgICAgICAgIHR5cGUgPSBjaGlsZC5wcm94eS5tZW1iZXIudHlwZTtcbiAgICAgICAgICAgIHN0YXRlID0gbmV3IFN0YXRlKHN0YXRlLCBjaGlsZC5wcm94eSwgdHlwZSwgbmV3IHR5cGUuaGFuZGxlcigpKTtcbiAgICAgICAgICB9XG5cbiAgICAgICAgICB0eXBlID0gY2hpbGQubWVtYmVyLnR5cGU7XG4gICAgICAgIH1cbiAgICAgIH1cblxuICAgICAgaWYgKHR5cGUgJiYgIXR5cGUuaXNQbGFpblByaW1pdGl2ZSkge1xuICAgICAgICBpdGVtID0gbmV3IHR5cGUuaGFuZGxlcigpO1xuXG4gICAgICAgIC8vIFBhcnNlIGFsbCBhdHRyaWJ1dGVzLlxuXG4gICAgICAgIGZvciAodmFyIGtleSBvZiBPYmplY3Qua2V5cyhhdHRyVGJsKSkge1xuICAgICAgICAgIHNwbGl0dGVyID0ga2V5LmluZGV4T2YoXCI6XCIpO1xuXG4gICAgICAgICAgaWYgKHNwbGl0dGVyID49IDApIHtcbiAgICAgICAgICAgIHZhciBhdHRyUHJlZml4ID0ga2V5LnN1YnN0cigwLCBzcGxpdHRlcik7XG4gICAgICAgICAgICBpZiAoYXR0clByZWZpeCA9PSBcInhtbG5zXCIpIGNvbnRpbnVlO1xuXG4gICAgICAgICAgICB2YXIgYXR0ck5hbWVzcGFjZSA9IHN0YXRlLm5hbWVzcGFjZVRibFthdHRyUHJlZml4XTtcblxuICAgICAgICAgICAgaWYgKGF0dHJOYW1lc3BhY2UpIHtcbiAgICAgICAgICAgICAgYXR0ciA9IGF0dHJOYW1lc3BhY2VbMV0gKyBrZXkuc3Vic3RyKHNwbGl0dGVyICsgMSk7XG4gICAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgICBjb25zb2xlLmxvZyhcIk5hbWVzcGFjZSBub3QgZm91bmQgZm9yIFwiICsga2V5KTtcbiAgICAgICAgICAgICAgY29udGludWU7XG4gICAgICAgICAgICB9XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIGF0dHIgPSBub2RlTmFtZXNwYWNlWzFdICsga2V5O1xuICAgICAgICAgIH1cblxuICAgICAgICAgIHZhciByZWYgPSB0eXBlLmF0dHJpYnV0ZVRibFthdHRyXTtcblxuICAgICAgICAgIGlmIChyZWYgJiYgcmVmLm1lbWJlci50eXBlLmlzUGxhaW5QcmltaXRpdmUpIHtcbiAgICAgICAgICAgIGl0ZW1bcmVmLnNhZmVOYW1lXSA9IGNvbnZlcnRQcmltaXRpdmUoXG4gICAgICAgICAgICAgIGF0dHJUYmxba2V5XSxcbiAgICAgICAgICAgICAgcmVmLm1lbWJlci50eXBlXG4gICAgICAgICAgICApO1xuICAgICAgICAgIH1cbiAgICAgICAgfVxuXG4gICAgICAgIGlmIChpdGVtLl9iZWZvcmUpIGl0ZW0uX2JlZm9yZSgpO1xuICAgICAgfVxuXG4gICAgICBzdGF0ZSA9IG5ldyBTdGF0ZShzdGF0ZSwgY2hpbGQsIHR5cGUsIGl0ZW0pO1xuICAgIH0pO1xuXG4gICAgeG1sLm9uKFwidGV4dFwiLCBmdW5jdGlvbiAodGV4dDogc3RyaW5nKSB7XG4gICAgICBpZiAoc3RhdGUudHlwZSAmJiBzdGF0ZS50eXBlLmlzUHJpbWl0aXZlKSB7XG4gICAgICAgIGlmICghc3RhdGUudGV4dExpc3QpIHN0YXRlLnRleHRMaXN0ID0gW107XG4gICAgICAgIHN0YXRlLnRleHRMaXN0LnB1c2godGV4dCk7XG4gICAgICB9XG4gICAgfSk7XG5cbiAgICB4bWwub24oXCJjbG9zZXRhZ1wiLCBmdW5jdGlvbiAobmFtZTogc3RyaW5nKSB7XG4gICAgICB2YXIgbWVtYmVyID0gc3RhdGUubWVtYmVyUmVmO1xuICAgICAgdmFyIG9iaiA9IHN0YXRlLml0ZW07XG4gICAgICB2YXIgaXRlbTogYW55ID0gb2JqO1xuICAgICAgdmFyIHRleHQ6IHN0cmluZztcblxuICAgICAgaWYgKHN0YXRlLnR5cGUgJiYgc3RhdGUudHlwZS5pc1ByaW1pdGl2ZSlcbiAgICAgICAgdGV4dCA9IChzdGF0ZS50ZXh0TGlzdCB8fCBbXSkuam9pbihcIlwiKS50cmltKCk7XG5cbiAgICAgIGlmICh0ZXh0KSB7XG4gICAgICAgIHZhciBjb250ZW50ID0gY29udmVydFByaW1pdGl2ZSh0ZXh0LCBzdGF0ZS50eXBlKTtcblxuICAgICAgICBpZiAoc3RhdGUudHlwZS5pc1BsYWluUHJpbWl0aXZlKSBpdGVtID0gY29udGVudDtcbiAgICAgICAgZWxzZSBvYmouY29udGVudCA9IGNvbnRlbnQ7XG4gICAgICB9XG5cbiAgICAgIGlmIChvYmogJiYgb2JqLl9hZnRlcikgb2JqLl9hZnRlcigpO1xuXG4gICAgICBzdGF0ZSA9IHN0YXRlLnBhcmVudDtcblxuICAgICAgaWYgKG1lbWJlciAmJiBtZW1iZXIucHJveHkpIHtcbiAgICAgICAgaWYgKGl0ZW0pIHN0YXRlLml0ZW1bbWVtYmVyLnNhZmVOYW1lXSA9IGl0ZW07XG4gICAgICAgIGl0ZW0gPSBzdGF0ZS5pdGVtO1xuXG4gICAgICAgIHN0YXRlID0gc3RhdGUucGFyZW50O1xuICAgICAgICBtZW1iZXIgPSBtZW1iZXIucHJveHk7XG4gICAgICB9XG5cbiAgICAgIGlmIChpdGVtKSB7XG4gICAgICAgIHZhciBwYXJlbnQgPSBzdGF0ZS5pdGVtO1xuXG4gICAgICAgIGlmIChwYXJlbnQpIHtcbiAgICAgICAgICBpZiAobWVtYmVyLm1heCA+IDEpIHtcbiAgICAgICAgICAgIGlmICghcGFyZW50Lmhhc093blByb3BlcnR5KG1lbWJlci5zYWZlTmFtZSkpXG4gICAgICAgICAgICAgIHBhcmVudFttZW1iZXIuc2FmZU5hbWVdID0gW107XG4gICAgICAgICAgICBwYXJlbnRbbWVtYmVyLnNhZmVOYW1lXS5wdXNoKGl0ZW0pO1xuICAgICAgICAgIH0gZWxzZSBwYXJlbnRbbWVtYmVyLnNhZmVOYW1lXSA9IGl0ZW07XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9KTtcblxuICAgIHhtbC5vbihcImVuZFwiLCBmdW5jdGlvbiAoKSB7XG4gICAgICByZXNvbHZlKChyb290U3RhdGUuaXRlbSBhcyBhbnkpIGFzIE91dHB1dCk7XG4gICAgfSk7XG5cbiAgICB4bWwub24oXCJlcnJvclwiLCBmdW5jdGlvbiAoZXJyOiBhbnkpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoZXJyKTtcbiAgICB9KTtcblxuICAgIGlmICh0eXBlb2Ygc3RyZWFtID09IFwic3RyaW5nXCIpIHtcbiAgICAgIHhtbC53cml0ZShzdHJlYW0gYXMgc3RyaW5nKTtcbiAgICAgIHhtbC5lbmQoKTtcbiAgICB9IGVsc2UgKHN0cmVhbSBhcyBzdHJlYW0uUmVhZGFibGUpLnBpcGUoeG1sKTtcbiAgfVxuXG4gIGNvbnRleHQ6IENvbnRleHQ7XG59XG4iXX0=