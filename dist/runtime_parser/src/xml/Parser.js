"use strict";
// This file is part of cxml, copyright (c) 2016 BusFaster Ltd.
// Released under the MIT license, see LICENSE.
Object.defineProperty(exports, "__esModule", { value: true });
exports.Parser = void 0;
var Promise = require("bluebird");
var sax = require("sax");
var State_1 = require("./State");
var JS_1 = require("../importer/JS");
var converterTbl = {
    Date: function (item) {
        var dateParts = item.match(/([0-9]+)-([0-9]+)-([0-9]+)(?:T([0-9]+):([0-9]+):([0-9]+)(\.[0-9]+)?)?(?:Z|([+-][0-9]+):([0-9]+))?/);
        var offsetMinutes = +(dateParts[9] || "0");
        var offset = +(dateParts[8] || "0") * 60;
        if (offset < 0)
            offsetMinutes = -offsetMinutes;
        offset += offsetMinutes;
        var date = new Date(+dateParts[1], +dateParts[2] - 1, +dateParts[3], +(dateParts[4] || "0"), +(dateParts[5] || "0"), +(dateParts[6] || "0"), +(dateParts[7] || "0") * 1000);
        date.setTime(date.getTime() - (offset + date.getTimezoneOffset()) * 60000);
        date.cxmlTimezoneOffset = offset;
        return date;
    },
    boolean: function (item) { return item == "true"; },
    string: function (item) { return item; },
    number: function (item) { return +item; },
};
function convertPrimitive(text, type) {
    var converter = converterTbl[type.primitiveType];
    if (converter) {
        if (type.isList) {
            return text.trim().split(/\s+/).map(converter);
        }
        else {
            return converter(text.trim());
        }
    }
    return null;
}
function sanitizeNonExistentFields(item) {
    switch (typeof item) {
        case "string":
        case "number":
        case "boolean":
        case "undefined":
            return item;
        case "object":
            if (item instanceof Date || item === null) {
                return item;
            }
            else if (item &&
                item.constructor &&
                item.constructor.name === "XmlType") {
                if (item._exists === false) {
                    return undefined;
                }
                else {
                    var itemDup = {};
                    for (var _i = 0, _a = Object.entries(item); _i < _a.length; _i++) {
                        var _b = _a[_i], prop = _b[0], value = _b[1];
                        if (prop === "constructor" ||
                            prop === "_exists" ||
                            prop === "_namespace")
                            continue;
                        var i = sanitizeNonExistentFields(value);
                        if (i !== undefined)
                            itemDup[prop] = i;
                    }
                    return itemDup;
                }
            }
            else if (Array.isArray(item)) {
                return item
                    .map(function (i) {
                    return sanitizeNonExistentFields(i);
                })
                    .filter(function (i) {
                    return i !== null && i !== undefined;
                });
            }
        default:
            return item;
    }
}
var Parser = /** @class */ (function () {
    function Parser() {
    }
    Parser.prototype.attach = function (handler) {
        var proto = handler.prototype;
        var realHandler = handler.type.handler;
        var realProto = realHandler.prototype;
        for (var _i = 0, _a = Object.keys(proto); _i < _a.length; _i++) {
            var key = _a[_i];
            realProto[key] = proto[key];
        }
        realHandler._custom = true;
    };
    Parser.prototype.parse = function (stream, output, context) {
        var _this = this;
        return new Promise(function (resolve, reject) {
            return _this._parse(stream, output, context, resolve, reject);
        });
    };
    Parser.prototype._parse = function (stream, output, context, resolve, reject) {
        var _this = this;
        this.context = context || JS_1.defaultContext;
        var xml = sax.createStream(true, { position: true });
        var type = output.constructor.type;
        var xmlSpace = this.context.registerNamespace("http://www.w3.org/XML/1998/namespace");
        var state = new State_1.State(null, null, type, new type.handler());
        var rootState = state;
        state.addNamespace("", type.namespace);
        if (xmlSpace)
            state.addNamespace("xml", xmlSpace);
        xml.on("opentag", function (node) {
            var attrTbl = node.attributes;
            var attr;
            var nodePrefix = "";
            var name = node.name;
            var splitter = name.indexOf(":");
            var item = null;
            // Read xmlns namespace prefix definitions before parsing node name.
            for (var _i = 0, _a = Object.keys(attrTbl); _i < _a.length; _i++) {
                var key = _a[_i];
                if (key.substr(0, 5) == "xmlns") {
                    var nsParts = key.match(/^xmlns(:(.+))?$/);
                    if (nsParts) {
                        state.addNamespace(nsParts[2] || "", _this.context.registerNamespace(attrTbl[key]));
                    }
                }
            }
            // Parse node name and possible namespace prefix.
            if (splitter >= 0) {
                nodePrefix = name.substr(0, splitter);
                name = name.substr(splitter + 1);
            }
            // Add internal surrogate key namespace prefix to node name.
            var nodeNamespace = state.namespaceTbl[nodePrefix];
            name = nodeNamespace[1] + name;
            var child;
            var type;
            if (state.type) {
                child = state.type.childTbl[name];
                if (child) {
                    if (child.proxy) {
                        type = child.proxy.member.type;
                        state = new State_1.State(state, child.proxy, type, new type.handler());
                    }
                    type = child.member.type;
                }
            }
            if (type && !type.isPlainPrimitive) {
                item = new type.handler();
                // Parse all attributes.
                for (var _b = 0, _c = Object.keys(attrTbl); _b < _c.length; _b++) {
                    var key = _c[_b];
                    splitter = key.indexOf(":");
                    if (splitter >= 0) {
                        var attrPrefix = key.substr(0, splitter);
                        if (attrPrefix == "xmlns")
                            continue;
                        var attrNamespace = state.namespaceTbl[attrPrefix];
                        if (attrNamespace) {
                            attr = attrNamespace[1] + key.substr(splitter + 1);
                        }
                        else {
                            console.log("Namespace not found for " + key);
                            continue;
                        }
                    }
                    else {
                        attr = nodeNamespace[1] + key;
                    }
                    var ref = type.attributeTbl[attr];
                    if (ref && ref.member.type.isPlainPrimitive) {
                        item[ref.safeName] = convertPrimitive(attrTbl[key], ref.member.type);
                    }
                }
                if (item._before)
                    item._before();
            }
            state = new State_1.State(state, child, type, item);
        });
        xml.on("text", function (text) {
            if (state.type && state.type.isPrimitive) {
                if (!state.textList)
                    state.textList = [];
                state.textList.push(text);
            }
        });
        xml.on("closetag", function (name) {
            var member = state.memberRef;
            var obj = state.item;
            var item = obj;
            var text;
            if (state.type && state.type.isPrimitive)
                text = (state.textList || []).join("").trim();
            if (text) {
                var content = convertPrimitive(text, state.type);
                if (state.type.isPlainPrimitive)
                    item = content;
                else
                    obj.content = content;
            }
            if (obj && obj._after)
                obj._after();
            state = state.parent;
            if (member && member.proxy) {
                if (item)
                    state.item[member.safeName] = item;
                item = state.item;
                state = state.parent;
                member = member.proxy;
            }
            if (item) {
                var parent = state.item;
                if (parent) {
                    if (member.max > 1) {
                        if (!parent.hasOwnProperty(member.safeName))
                            parent[member.safeName] = [];
                        parent[member.safeName].push(item);
                    }
                    else {
                        parent[member.safeName] = item;
                    }
                }
            }
        });
        xml.on("end", function () {
            resolve(sanitizeNonExistentFields(rootState.item));
        });
        xml.on("error", function (err) {
            console.error(err);
        });
        if (typeof stream == "string") {
            xml.write(stream);
            xml.end();
        }
        else
            stream.pipe(xml);
    };
    return Parser;
}());
exports.Parser = Parser;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiUGFyc2VyLmpzIiwic291cmNlUm9vdCI6IiIsInNvdXJjZXMiOlsiLi4vLi4vLi4vLi4vcnVudGltZV9wYXJzZXIvc3JjL3htbC9QYXJzZXIudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6IjtBQUFBLCtEQUErRDtBQUMvRCwrQ0FBK0M7OztBQUcvQyxrQ0FBb0M7QUFDcEMseUJBQTJCO0FBSzNCLGlDQUFnQztBQUNoQyxxQ0FBZ0Q7QUFNaEQsSUFBSSxZQUFZLEdBQThDO0lBQzVELElBQUksRUFBRSxVQUFDLElBQVk7UUFDakIsSUFBSSxTQUFTLEdBQUcsSUFBSSxDQUFDLEtBQUssQ0FDeEIsbUdBQW1HLENBQ3BHLENBQUM7UUFDRixJQUFJLGFBQWEsR0FBRyxDQUFDLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxJQUFJLEdBQUcsQ0FBQyxDQUFDO1FBQzNDLElBQUksTUFBTSxHQUFHLENBQUMsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLElBQUksR0FBRyxDQUFDLEdBQUcsRUFBRSxDQUFDO1FBRXpDLElBQUksTUFBTSxHQUFHLENBQUM7WUFBRSxhQUFhLEdBQUcsQ0FBQyxhQUFhLENBQUM7UUFFL0MsTUFBTSxJQUFJLGFBQWEsQ0FBQztRQUV4QixJQUFJLElBQUksR0FBRyxJQUFJLElBQUksQ0FDakIsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLEVBQ2IsQ0FBQyxTQUFTLENBQUMsQ0FBQyxDQUFDLEdBQUcsQ0FBQyxFQUNqQixDQUFDLFNBQVMsQ0FBQyxDQUFDLENBQUMsRUFDYixDQUFDLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxJQUFJLEdBQUcsQ0FBQyxFQUN0QixDQUFDLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxJQUFJLEdBQUcsQ0FBQyxFQUN0QixDQUFDLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxJQUFJLEdBQUcsQ0FBQyxFQUN0QixDQUFDLENBQUMsU0FBUyxDQUFDLENBQUMsQ0FBQyxJQUFJLEdBQUcsQ0FBQyxHQUFHLElBQUksQ0FD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RUFBRSxDQUFDLE9BQU8sRUFBRSxVQUFVLEdBQVE7WUFDaEMsT0FBTyxDQUFDLEtBQUssQ0FBQyxHQUFHLENBQUMsQ0FBQztRQUNyQixDQUFDLENBQUMsQ0FBQztRQUVILElBQUksT0FBTyxNQUFNLElBQUksUUFBUSxFQUFFO1lBQzdCLEdBQUcsQ0FBQyxLQUFLLENBQUMsTUFBZ0IsQ0FBQyxDQUFDO1lBQzVCLEdBQUcsQ0FBQyxHQUFHLEVBQUUsQ0FBQztTQUNYOztZQUFPLE1BQTBCLENBQUMsSUFBSSxDQUFDLEdBQUcsQ0FBQyxDQUFDO0lBQy9DLENBQUM7SUFHSCxhQUFDO0FBQUQsQ0FBQyxBQTNNRCxJQTJNQztBQTNNWSx3QkFBTSIsInNvdXJjZXNDb250ZW50IjpbIi8vIFRoaXMgZmlsZSBpcyBwYXJ0IG9mIGN4bWwsIGNvcHlyaWdodCAoYykgMjAxNiBCdXNGYXN0ZXIgTHRkLlxuLy8gUmVsZWFzZWQgdW5kZXIgdGhlIE1JVCBsaWNlbnNlLCBzZWUgTElDRU5TRS5cblxuaW1wb3J0ICogYXMgc3RyZWFtIGZyb20gXCJzdHJlYW1cIjtcbmltcG9ydCAqIGFzIFByb21pc2UgZnJvbSBcImJsdWViaXJkXCI7XG5pbXBvcnQgKiBhcyBzYXggZnJvbSBcInNheFwiO1xuXG5pbXBvcnQgeyBDb250ZXh0IH0gZnJvbSBcIi4vQ29udGV4dFwiO1xuaW1wb3J0IHsgVHlwZSwgVHlwZUNsYXNzLCBIYW5kbGVySW5zdGFuY2UgfSBmcm9tIFwiLi9UeXBlXCI7XG5pbXBvcnQgeyBNZW1iZXJSZWYgfSBmcm9tIFwiLi9NZW1iZXJSZWZcIjtcbmltcG9ydCB7IFN0YXRlIH0gZnJvbSBcIi4vU3RhdGVcIjtcbmltcG9ydCB7IGRlZmF1bHRDb250ZXh0IH0gZnJvbSBcIi4uL2ltcG9ydGVyL0pTXCI7XG5cbmV4cG9ydCBpbnRlcmZhY2UgQ3htbERhdGUgZXh0ZW5kcyBEYXRlIHtcbiAgY3htbFRpbWV6b25lT2Zmc2V0OiBudW1iZXI7XG59XG5cbnZhciBjb252ZXJ0ZXJUYmw6IHsgW3R5cGU6IHN0cmluZ106IChpdGVtOiBzdHJpbmcpID0+IGFueSB9ID0ge1xuICBEYXRlOiAoaXRlbTogc3RyaW5nKSA9PiB7XG4gICAgdmFyIGRhdGVQYXJ0cyA9IGl0ZW0ubWF0Y2goXG4gICAgICAvKFswLTldKyktKFswLTldKyktKFswLTldKykoPzpUKFswLTldKyk6KFswLTldKyk6KFswLTldKykoXFwuWzAtOV0rKT8pPyg/Olp8KFsrLV1bMC05XSspOihbMC05XSspKT8vXG4gICAgKTtcbiAgICB2YXIgb2Zmc2V0TWludXRlcyA9ICsoZGF0ZVBhcnRzWzldIHx8IFwiMFwiKTtcbiAgICB2YXIgb2Zmc2V0ID0gKyhkYXRlUGFydHNbOF0gfHwgXCIwXCIpICogNjA7XG5cbiAgICBpZiAob2Zmc2V0IDwgMCkgb2Zmc2V0TWludXRlcyA9IC1vZmZzZXRNaW51dGVzO1xuXG4gICAgb2Zmc2V0ICs9IG9mZnNldE1pbnV0ZXM7XG5cbiAgICB2YXIgZGF0ZSA9IG5ldyBEYXRlKFxuICAgICAgK2RhdGVQYXJ0c1sxXSxcbiAgICAgICtkYXRlUGFydHNbMl0gLSAxLFxuICAgICAgK2RhdGVQYXJ0c1szXSxcbiAgICAgICsoZGF0ZVBhcnRzWzRdIHx8IFwiMFwiKSxcbiAgICAgICsoZGF0ZVBhcnRzWzVdIHx8IFwiMFwiKSxcbiAgICAgICsoZGF0ZVBhcnRzWzZdIHx8IFwiMFwiKSxcbiAgICAgICsoZGF0ZVBhcnRzWzddIHx8IFwiMFwiKSAqIDEwMDBcbiAgICApIGFzIEN4bWxEYXRlO1xuXG4gICAgZGF0ZS5zZXRUaW1lKGRhdGUuZ2V0VGltZSgpIC0gKG9mZnNldCArIGRhdGUuZ2V0VGltZXpvbmVPZmZzZXQoKSkgKiA2MDAwMCk7XG4gICAgZGF0ZS5jeG1sVGltZXpvbmVPZmZzZXQgPSBvZmZzZXQ7XG5cbiAgICByZXR1cm4gZGF0ZTtcbiAgfSxcbiAgYm9vbGVhbjogKGl0ZW06IHN0cmluZykgPT4gaXRlbSA9PSBcInRydWVcIixcbiAgc3RyaW5nOiAoaXRlbTogc3RyaW5nKSA9PiBpdGVtLFxuICBudW1iZXI6IChpdGVtOiBzdHJpbmcpID0+ICtpdGVtLFxufTtcblxuZnVuY3Rpb24gY29udmVydFByaW1pdGl2ZSh0ZXh0OiBzdHJpbmcsIHR5cGU6IFR5cGUpIHtcbiAgdmFyIGNvbnZlcnRlciA9IGNvbnZlcnRlclRibFt0eXBlLnByaW1pdGl2ZVR5cGVdO1xuXG4gIGlmIChjb252ZXJ0ZXIpIHtcbiAgICBpZiAodHlwZS5pc0xpc3QpIHtcbiAgICAgIHJldHVybiB0ZXh0LnRyaW0oKS5zcGxpdCgvXFxzKy8pLm1hcChjb252ZXJ0ZXIpO1xuICAgIH0gZWxzZSB7XG4gICAgICByZXR1cm4gY29udmVydGVyKHRleHQudHJpbSgpKTtcbiAgICB9XG4gIH1cblxuICByZXR1cm4gbnVsbDtcbn1cbmZ1bmN0aW9uIHNhbml0aXplTm9uRXhpc3RlbnRGaWVsZHMoaXRlbTogYW55KTogYW55IHtcbiAgc3dpdGNoICh0eXBlb2YgaXRlbSkge1xuICAgIGNhc2UgXCJzdHJpbmdcIjpcbiAgICBjYXNlIFwibnVtYmVyXCI6XG4gICAgY2FzZSBcImJvb2xlYW5cIjpcbiAgICBjYXNlIFwidW5kZWZpbmVkXCI6XG4gICAgICByZXR1cm4gaXRlbTtcbiAgICBjYXNlIFwib2JqZWN0XCI6XG4gICAgICBpZiAoaXRlbSBpbnN0YW5jZW9mIERhdGUgfHwgaXRlbSA9PT0gbnVsbCkge1xuICAgICAgICByZXR1cm4gaXRlbTtcbiAgICAgIH0gZWxzZSBpZiAoXG4gICAgICAgIGl0ZW0gJiZcbiAgICAgICAgaXRlbS5jb25zdHJ1Y3RvciAmJlxuICAgICAgICBpdGVtLmNvbnN0cnVjdG9yLm5hbWUgPT09IFwiWG1sVHlwZVwiXG4gICAgICApIHtcbiAgICAgICAgaWYgKGl0ZW0uX2V4aXN0cyA9PT0gZmFsc2UpIHtcbiAgICAgICAgICByZXR1cm4gdW5kZWZpbmVkO1xuICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgIGNvbnN0IGl0ZW1EdXA6IFJlY29yZDxzdHJpbmcsIGFueT4gPSB7fTtcbiAgICAgICAgICBmb3IgKGNvbnN0IFtwcm9wLCB2YWx1ZV0gb2YgT2JqZWN0LmVudHJpZXMoaXRlbSkpIHtcbiAgICAgICAgICAgIGlmIChcbiAgICAgICAgICAgICAgcHJvcCA9PT0gXCJjb25zdHJ1Y3RvclwiIHx8XG4gICAgICAgICAgICAgIHByb3AgPT09IFwiX2V4aXN0c1wiIHx8XG4gICAgICAgICAgICAgIHByb3AgPT09IFwiX25hbWVzcGFjZVwiXG4gICAgICAgICAgICApXG4gICAgICAgICAgICAgIGNvbnRpbnVlO1xuICAgICAgICAgICAgdmFyIGkgPSBzYW5pdGl6ZU5vbkV4aXN0ZW50RmllbGRzKHZhbHVlKTtcbiAgICAgICAgICAgIGlmIChpICE9PSB1bmRlZmluZWQpIGl0ZW1EdXBbcHJvcF0gPSBpO1xuICAgICAgICAgIH1cbiAgICAgICAgICByZXR1cm4gaXRlbUR1cDtcbiAgICAgICAgfVxuICAgICAgfSBlbHNlIGlmIChBcnJheS5pc0FycmF5KGl0ZW0pKSB7XG4gICAgICAgIHJldHVybiBpdGVtXG4gICAgICAgICAgLm1hcChmdW5jdGlvbiAoaSkge1xuICAgICAgICAgICAgcmV0dXJuIHNhbml0aXplTm9uRXhpc3RlbnRGaWVsZHMoaSk7XG4gICAgICAgICAgfSlcbiAgICAgICAgICAuZmlsdGVyKGZ1bmN0aW9uIChpKSB7XG4gICAgICAgICAgICByZXR1cm4gaSAhPT0gbnVsbCAmJiBpICE9PSB1bmRlZmluZWQ7XG4gICAgICAgICAgfSk7XG4gICAgICB9XG4gICAgZGVmYXVsdDpcbiAgICAgIHJldHVybiBpdGVtO1xuICB9XG59XG5cbmV4cG9ydCBjbGFzcyBQYXJzZXIge1xuICBhdHRhY2g8Q3VzdG9tSGFuZGxlciBleHRlbmRzIEhhbmRsZXJJbnN0YW5jZT4oaGFuZGxlcjoge1xuICAgIG5ldyAoKTogQ3VzdG9tSGFuZGxlcjtcbiAgfSkge1xuICAgIHZhciBwcm90byA9IGhhbmRsZXIucHJvdG90eXBlIGFzIEN1c3RvbUhhbmRsZXI7XG4gICAgdmFyIHJlYWxIYW5kbGVyID0gKGhhbmRsZXIgYXMgVHlwZUNsYXNzKS50eXBlLmhhbmRsZXI7XG4gICAgdmFyIHJlYWxQcm90byA9IHJlYWxIYW5kbGVyLnByb3RvdHlwZSBhcyBDdXN0b21IYW5kbGVyO1xuXG4gICAgZm9yICh2YXIga2V5IG9mIE9iamVjdC5rZXlzKHByb3RvKSkge1xuICAgICAgcmVhbFByb3RvW2tleSBhcyBrZXlvZiBDdXN0b21IYW5kbGVyXSA9IHByb3RvW2tleV07XG4gICAgfVxuXG4gICAgcmVhbEhhbmRsZXIuX2N1c3RvbSA9IHRydWU7XG4gIH1cblxuICBwYXJzZTxPdXRwdXQgZXh0ZW5kcyBIYW5kbGVySW5zdGFuY2U+KFxuICAgIHN0cmVhbTogc3RyaW5nIHwgc3RyZWFtLlJlYWRhYmxlIHwgTm9kZUpTLlJlYWRhYmxlU3RyZWFtLFxuICAgIG91dHB1dDogT3V0cHV0LFxuICAgIGNvbnRleHQ/OiBDb250ZXh0XG4gICkge1xuICAgIHJldHVybiBuZXcgUHJvbWlzZTxPdXRwdXQ+KFxuICAgICAgKHJlc29sdmU6IChpdGVtOiBPdXRwdXQpID0+IHZvaWQsIHJlamVjdDogKGVycjogYW55KSA9PiB2b2lkKSA9PlxuICAgICAgICB0aGlzLl9wYXJzZTxPdXRwdXQ+KHN0cmVhbSwgb3V0cHV0LCBjb250ZXh0LCByZXNvbHZlLCByZWplY3QpXG4gICAgKTtcbiAgfVxuXG4gIF9wYXJzZTxPdXRwdXQgZXh0ZW5kcyBIYW5kbGVySW5zdGFuY2U+KFxuICAgIHN0cmVhbTogc3RyaW5nIHwgc3RyZWFtLlJlYWRhYmxlIHwgTm9kZUpTLlJlYWRhYmxlU3RyZWFtLFxuICAgIG91dHB1dDogT3V0cHV0LFxuICAgIGNvbnRleHQ6IENvbnRleHQsXG4gICAgcmVzb2x2ZTogKGl0ZW06IE91dHB1dCkgPT4gdm9pZCxcbiAgICByZWplY3Q6IChlcnI6IGFueSkgPT4gdm9pZFxuICApIHtcbiAgICB0aGlzLmNvbnRleHQgPSBjb250ZXh0IHx8IGRlZmF1bHRDb250ZXh0O1xuXG4gICAgdmFyIHhtbCA9IHNheC5jcmVhdGVTdHJlYW0odHJ1ZSwgeyBwb3NpdGlvbjogdHJ1ZSB9KTtcbiAgICB2YXIgdHlwZSA9IChvdXRwdXQuY29uc3RydWN0b3IgYXMgVHlwZUNsYXNzKS50eXBlO1xuXG4gICAgdmFyIHhtbFNwYWNlID0gdGhpcy5jb250ZXh0LnJlZ2lzdGVyTmFtZXNwYWNlKFxuICAgICAgXCJodHRwOi8vd3d3LnczLm9yZy9YTUwvMTk5OC9uYW1lc3BhY2VcIlxuICAgICk7XG4gICAgdmFyIHN0YXRlID0gbmV3IFN0YXRlKG51bGwsIG51bGwsIHR5cGUsIG5ldyB0eXBlLmhhbmRsZXIoKSk7XG4gICAgdmFyIHJvb3RTdGF0ZSA9IHN0YXRlO1xuXG4gICAgc3RhdGUuYWRkTmFtZXNwYWNlKFwiXCIsIHR5cGUubmFtZXNwYWNlKTtcbiAgICBpZiAoeG1sU3BhY2UpIHN0YXRlLmFkZE5hbWVzcGFjZShcInhtbFwiLCB4bWxTcGFjZSk7XG5cbiAgICB4bWwub24oXCJvcGVudGFnXCIsIChub2RlOiBzYXguVGFnKSA9PiB7XG4gICAgICB2YXIgYXR0clRibCA9IG5vZGUuYXR0cmlidXRlcztcbiAgICAgIHZhciBhdHRyOiBzdHJpbmc7XG4gICAgICB2YXIgbm9kZVByZWZpeCA9IFwiXCI7XG4gICAgICB2YXIgbmFtZSA9IG5vZGUubmFtZTtcbiAgICAgIHZhciBzcGxpdHRlciA9IG5hbWUuaW5kZXhPZihcIjpcIik7XG4gICAgICB2YXIgaXRlbTogSGFuZGxlckluc3RhbmNlID0gbnVsbDtcblxuICAgICAgLy8gUmVhZCB4bWxucyBuYW1lc3BhY2UgcHJlZml4IGRlZmluaXRpb25zIGJlZm9yZSBwYXJzaW5nIG5vZGUgbmFtZS5cblxuICAgICAgZm9yICh2YXIga2V5IG9mIE9iamVjdC5rZXlzKGF0dHJUYmwpKSB7XG4gICAgICAgIGlmIChrZXkuc3Vic3RyKDAsIDUpID09IFwieG1sbnNcIikge1xuICAgICAgICAgIHZhciBuc1BhcnRzID0ga2V5Lm1hdGNoKC9eeG1sbnMoOiguKykpPyQvKTtcblxuICAgICAgICAgIGlmIChuc1BhcnRzKSB7XG4gICAgICAgICAgICBzdGF0ZS5hZGROYW1lc3BhY2UoXG4gICAgICAgICAgICAgIG5zUGFydHNbMl0gfHwgXCJcIixcbiAgICAgICAgICAgICAgdGhpcy5jb250ZXh0LnJlZ2lzdGVyTmFtZXNwYWNlKGF0dHJUYmxba2V5XSlcbiAgICAgICAgICAgICk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG4gICAgICB9XG5cbiAgICAgIC8vIFBhcnNlIG5vZGUgbmFtZSBhbmQgcG9zc2libGUgbmFtZXNwYWNlIHByZWZpeC5cblxuICAgICAgaWYgKHNwbGl0dGVyID49IDApIHtcbiAgICAgICAgbm9kZVByZWZpeCA9IG5hbWUuc3Vic3RyKDAsIHNwbGl0dGVyKTtcbiAgICAgICAgbmFtZSA9IG5hbWUuc3Vic3RyKHNwbGl0dGVyICsgMSk7XG4gICAgICB9XG5cbiAgICAgIC8vIEFkZCBpbnRlcm5hbCBzdXJyb2dhdGUga2V5IG5hbWVzcGFjZSBwcmVmaXggdG8gbm9kZSBuYW1lLlxuXG4gICAgICB2YXIgbm9kZU5hbWVzcGFjZSA9IHN0YXRlLm5hbWVzcGFjZVRibFtub2RlUHJlZml4XTtcbiAgICAgIG5hbWUgPSBub2RlTmFtZXNwYWNlWzFdICsgbmFtZTtcblxuICAgICAgdmFyIGNoaWxkOiBNZW1iZXJSZWY7XG4gICAgICB2YXIgdHlwZTogVHlwZTtcblxuICAgICAgaWYgKHN0YXRlLnR5cGUpIHtcbiAgICAgICAgY2hpbGQgPSBzdGF0ZS50eXBlLmNoaWxkVGJsW25hbWVdO1xuXG4gICAgICAgIGlmIChjaGlsZCkge1xuICAgICAgICAgIGlmIChjaGlsZC5wcm94eSkge1xuICAgICAgICAgICAgdHlwZSA9IGNoaWxkLnByb3h5Lm1lbWJlci50eXBlO1xuICAgICAgICAgICAgc3RhdGUgPSBuZXcgU3RhdGUoc3RhdGUsIGNoaWxkLnByb3h5LCB0eXBlLCBuZXcgdHlwZS5oYW5kbGVyKCkpO1xuICAgICAgICAgIH1cblxuICAgICAgICAgIHR5cGUgPSBjaGlsZC5tZW1iZXIudHlwZTtcbiAgICAgICAgfVxuICAgICAgfVxuXG4gICAgICBpZiAodHlwZSAmJiAhdHlwZS5pc1BsYWluUHJpbWl0aXZlKSB7XG4gICAgICAgIGl0ZW0gPSBuZXcgdHlwZS5oYW5kbGVyKCk7XG5cbiAgICAgICAgLy8gUGFyc2UgYWxsIGF0dHJpYnV0ZXMuXG5cbiAgICAgICAgZm9yICh2YXIga2V5IG9mIE9iamVjdC5rZXlzKGF0dHJUYmwpKSB7XG4gICAgICAgICAgc3BsaXR0ZXIgPSBrZXkuaW5kZXhPZihcIjpcIik7XG5cbiAgICAgICAgICBpZiAoc3BsaXR0ZXIgPj0gMCkge1xuICAgICAgICAgICAgdmFyIGF0dHJQcmVmaXggPSBrZXkuc3Vic3RyKDAsIHNwbGl0dGVyKTtcbiAgICAgICAgICAgIGlmIChhdHRyUHJlZml4ID09IFwieG1sbnNcIikgY29udGludWU7XG5cbiAgICAgICAgICAgIHZhciBhdHRyTmFtZXNwYWNlID0gc3RhdGUubmFtZXNwYWNlVGJsW2F0dHJQcmVmaXhdO1xuXG4gICAgICAgICAgICBpZiAoYXR0ck5hbWVzcGFjZSkge1xuICAgICAgICAgICAgICBhdHRyID0gYXR0ck5hbWVzcGFjZVsxXSArIGtleS5zdWJzdHIoc3BsaXR0ZXIgKyAxKTtcbiAgICAgICAgICAgIH0gZWxzZSB7XG4gICAgICAgICAgICAgIGNvbnNvbGUubG9nKFwiTmFtZXNwYWNlIG5vdCBmb3VuZCBmb3IgXCIgKyBrZXkpO1xuICAgICAgICAgICAgICBjb250aW51ZTtcbiAgICAgICAgICAgIH1cbiAgICAgICAgICB9IGVsc2Uge1xuICAgICAgICAgICAgYXR0ciA9IG5vZGVOYW1lc3BhY2VbMV0gKyBrZXk7XG4gICAgICAgICAgfVxuXG4gICAgICAgICAgdmFyIHJlZiA9IHR5cGUuYXR0cmlidXRlVGJsW2F0dHJdO1xuXG4gICAgICAgICAgaWYgKHJlZiAmJiByZWYubWVtYmVyLnR5cGUuaXNQbGFpblByaW1pdGl2ZSkge1xuICAgICAgICAgICAgaXRlbVtyZWYuc2FmZU5hbWVdID0gY29udmVydFByaW1pdGl2ZShcbiAgICAgICAgICAgICAgYXR0clRibFtrZXldLFxuICAgICAgICAgICAgICByZWYubWVtYmVyLnR5cGVcbiAgICAgICAgICAgICk7XG4gICAgICAgICAgfVxuICAgICAgICB9XG5cbiAgICAgICAgaWYgKGl0ZW0uX2JlZm9yZSkgaXRlbS5fYmVmb3JlKCk7XG4gICAgICB9XG5cbiAgICAgIHN0YXRlID0gbmV3IFN0YXRlKHN0YXRlLCBjaGlsZCwgdHlwZSwgaXRlbSk7XG4gICAgfSk7XG5cbiAgICB4bWwub24oXCJ0ZXh0XCIsIGZ1bmN0aW9uICh0ZXh0OiBzdHJpbmcpIHtcbiAgICAgIGlmIChzdGF0ZS50eXBlICYmIHN0YXRlLnR5cGUuaXNQcmltaXRpdmUpIHtcbiAgICAgICAgaWYgKCFzdGF0ZS50ZXh0TGlzdCkgc3RhdGUudGV4dExpc3QgPSBbXTtcbiAgICAgICAgc3RhdGUudGV4dExpc3QucHVzaCh0ZXh0KTtcbiAgICAgIH1cbiAgICB9KTtcblxuICAgIHhtbC5vbihcImNsb3NldGFnXCIsIGZ1bmN0aW9uIChuYW1lOiBzdHJpbmcpIHtcbiAgICAgIHZhciBtZW1iZXIgPSBzdGF0ZS5tZW1iZXJSZWY7XG4gICAgICB2YXIgb2JqID0gc3RhdGUuaXRlbTtcbiAgICAgIHZhciBpdGVtOiBhbnkgPSBvYmo7XG4gICAgICB2YXIgdGV4dDogc3RyaW5nO1xuXG4gICAgICBpZiAoc3RhdGUudHlwZSAmJiBzdGF0ZS50eXBlLmlzUHJpbWl0aXZlKVxuICAgICAgICB0ZXh0ID0gKHN0YXRlLnRleHRMaXN0IHx8IFtdKS5qb2luKFwiXCIpLnRyaW0oKTtcblxuICAgICAgaWYgKHRleHQpIHtcbiAgICAgICAgdmFyIGNvbnRlbnQgPSBjb252ZXJ0UHJpbWl0aXZlKHRleHQsIHN0YXRlLnR5cGUpO1xuXG4gICAgICAgIGlmIChzdGF0ZS50eXBlLmlzUGxhaW5QcmltaXRpdmUpIGl0ZW0gPSBjb250ZW50O1xuICAgICAgICBlbHNlIG9iai5jb250ZW50ID0gY29udGVudDtcbiAgICAgIH1cblxuICAgICAgaWYgKG9iaiAmJiBvYmouX2FmdGVyKSBvYmouX2FmdGVyKCk7XG5cbiAgICAgIHN0YXRlID0gc3RhdGUucGFyZW50O1xuXG4gICAgICBpZiAobWVtYmVyICYmIG1lbWJlci5wcm94eSkge1xuICAgICAgICBpZiAoaXRlbSkgc3RhdGUuaXRlbVttZW1iZXIuc2FmZU5hbWVdID0gaXRlbTtcbiAgICAgICAgaXRlbSA9IHN0YXRlLml0ZW07XG5cbiAgICAgICAgc3RhdGUgPSBzdGF0ZS5wYXJlbnQ7XG4gICAgICAgIG1lbWJlciA9IG1lbWJlci5wcm94eTtcbiAgICAgIH1cblxuICAgICAgaWYgKGl0ZW0pIHtcbiAgICAgICAgdmFyIHBhcmVudCA9IHN0YXRlLml0ZW07XG5cbiAgICAgICAgaWYgKHBhcmVudCkge1xuICAgICAgICAgIGlmIChtZW1iZXIubWF4ID4gMSkge1xuICAgICAgICAgICAgaWYgKCFwYXJlbnQuaGFzT3duUHJvcGVydHkobWVtYmVyLnNhZmVOYW1lKSlcbiAgICAgICAgICAgICAgcGFyZW50W21lbWJlci5zYWZlTmFtZV0gPSBbXTtcbiAgICAgICAgICAgIHBhcmVudFttZW1iZXIuc2FmZU5hbWVdLnB1c2goaXRlbSk7XG4gICAgICAgICAgfSBlbHNlIHtcbiAgICAgICAgICAgIHBhcmVudFttZW1iZXIuc2FmZU5hbWVdID0gaXRlbTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9KTtcblxuICAgIHhtbC5vbihcImVuZFwiLCBmdW5jdGlvbiAoKSB7XG4gICAgICByZXNvbHZlKChzYW5pdGl6ZU5vbkV4aXN0ZW50RmllbGRzKHJvb3RTdGF0ZS5pdGVtKSBhcyBhbnkpIGFzIE91dHB1dCk7XG4gICAgfSk7XG5cbiAgICB4bWwub24oXCJlcnJvclwiLCBmdW5jdGlvbiAoZXJyOiBhbnkpIHtcbiAgICAgIGNvbnNvbGUuZXJyb3IoZXJyKTtcbiAgICB9KTtcblxuICAgIGlmICh0eXBlb2Ygc3RyZWFtID09IFwic3RyaW5nXCIpIHtcbiAgICAgIHhtbC53cml0ZShzdHJlYW0gYXMgc3RyaW5nKTtcbiAgICAgIHhtbC5lbmQoKTtcbiAgICB9IGVsc2UgKHN0cmVhbSBhcyBzdHJlYW0uUmVhZGFibGUpLnBpcGUoeG1sKTtcbiAgfVxuXG4gIGNvbnRleHQ6IENvbnRleHQ7XG59XG4iXX0=